# OS D1 Setup

---

[Entries](https://www.notion.so/OS-D1-Setup-202d8836ce4380c9b9f1c58b7c2cc7f4?pvs=21)

[Pyramids](https://www.notion.so/OS-D1-Setup-202d8836ce4380c9b9f1c58b7c2cc7f4?pvs=21)

[Covers](https://www.notion.so/OS-D1-Setup-202d8836ce4380c9b9f1c58b7c2cc7f4?pvs=21)

[Risk](https://www.notion.so/OS-D1-Setup-202d8836ce4380c9b9f1c58b7c2cc7f4?pvs=21)

[A+ Criteria](https://www.notion.so/OS-D1-Setup-202d8836ce4380c9b9f1c58b7c2cc7f4?pvs=21)

[Frontside](https://www.notion.so/OS-D1-Setup-202d8836ce4380c9b9f1c58b7c2cc7f4?pvs=21)

[High & Tight](https://www.notion.so/OS-D1-Setup-202d8836ce4380c9b9f1c58b7c2cc7f4?pvs=21)

[Backside Pop](https://www.notion.so/OS-D1-Setup-202d8836ce4380c9b9f1c58b7c2cc7f4?pvs=21)

[Deep or Reverted backside](https://www.notion.so/OS-D1-Setup-202d8836ce4380c9b9f1c58b7c2cc7f4?pvs=21)

## Setup Overview

The way our d1’s work, we have 3 main high ev points where we enter, FBO, Extension, or Dev band pop

From here at 9:25 we can classify our opening stage, this helps us better understand the context of the setup and tailor approach given on the setup

Open Stage Classification

- Frontside until 5m trig
- High and tight until close below 5m 20 ema or 15m trig
- Backside until multiple closes below 15m 20ema or 15m 9/20 cross
- Deep Backside until 5m bdb hit pre pop, then its
- Reverted D1

High EV Spots

- Extensions
    
    Best are all non Frontside, open or morning timing wise
    
    the best extensions come from high and tight or below, most of the frontside extensions arent good
    
    the best ext go parabolic and really extend from the initial consolidation
    
    With Extensions we have 2 high odd spots, the open, and the blowoff
    
    most of our A+ setups happen within the first hour and within the first 2 bar breaks
    
    Setups with 1 5m bb top have 83% change of A or better
    
    Setups with 2 5m bb top have 58% chance of A better but all B were 100% green names
    
    setups with 3/4 have a 28% change of A and 42% chance of B, likely making less on the B’s
    
    Seemingly our best approach with extensions is to try the first 2 BB and if there is a blowout can try the third. i initially was thinking we want to not take the second unless blowout but on further review they are worth while over the long term, maybe the best bet is when quality setup try 2nd bb when less quality setup wait for better blowout or enter post vwap as 99% of these pop well
    i think starters have to be very limited to here for only the opening ext and then a parabolic blowoff and only 1 .25R attempt
    
    [Untitled](OS%20D1%20Setup%20202d8836ce4380c9b9f1c58b7c2cc7f4/Untitled%20239d8836ce43800ea094d7e2ffb026e7.csv)
    
- FBO
    
    opening FBO across all setups - 70.6% change A better
    
    Open FBO 77% chance of A better
    
    morning FBO - 55% chance A better the rest of the time its C grade
    morning + open - 67% a better
    
    High and tight or Frontside is 71% a better
    
    Backside or Deep backside is 68% A better, deep backside is better than backside here. fbo on backside are good but not as good as the rest
    
    all FBO imo deserve a starter this is one of our best ev spots
    
    only 4 opening fbo fo a 15m dev band push so waiting for a fail there shouldnt get in the way.
    
    [Untitled](OS%20D1%20Setup%20202d8836ce4380c9b9f1c58b7c2cc7f4/Untitled%20238d8836ce4380249dfcd36169d51ff4.csv)
    

- Open Stages notes
    - Frontside
        
        Lower Grade Setup, 41% chance of A or better 16% are C
        
        dont think we want to be as aggro with these, maybe just use the 5m and pops have to look into it more, process is -1.43R
        
        opening fbo are best here 3/4 a better
        
        opening extensions arent as good only 28% A better
        
        On Frontside, look mostly for opening fbo, opening ext is valid just have to be aware the quality of opp is lower. opening fail is valid too
        
        [Untitled](OS%20D1%20Setup%20202d8836ce4380c9b9f1c58b7c2cc7f4/Untitled%2023ad8836ce4380b0b895dd2b83266063.csv)
        
    - High Range Post Fail
        
        Much higher grade setup here, 56.8% A or A+. only 22.7% are a C
        
        Opening and morning fbo are good
        
        Opening FBO A++ 80% chance A better
        
        opening extension great 75% a better
        
        morning FBO and EXT valid not as good but still good morning fbo 50% of a, morning ext 35.7% a better
        
        5m db push, 7/18 go higher after push so need to keep it .25 as decent odds for continue higher
        
        most 5m db pushes happen right at open, need to trust the band and the stall/fail - only opening dev band, no entries after first 15m
        
        only opening fbo, ext or 5m db push, 65.8% a better
        
        once adding in morning fbo and ext, 62.5%
        
        [Untitled](OS%20D1%20Setup%20202d8836ce4380c9b9f1c58b7c2cc7f4/Untitled%20238d8836ce43803e8efff030a01a1707.csv)
        
    - Backside Pop
        
        Much higher grade setup here, 60% A or A+. only 9% are a C
        
        Opening FBO A+ 72.8% chance A better
        
        opening extension great 2/3 a better
        
        morning ext so so, fbo not good
        
        really just an open centric setup
        
        15m db push solid only 5/35 go higher
        
        backside pop - 15m db push gets starter, opening fbo
        
        opening/morning ext valid, ideally want blowout
        
        [Untitled](OS%20D1%20Setup%20202d8836ce4380c9b9f1c58b7c2cc7f4/Untitled%2023ad8836ce4381b2a333e5130c0811fe.csv)
        
    - Deep Backside and Backside Reverted
        
        if Deep Backside Pop Setup, 
        first confirm that we had a liquid pm ext and fade off, if yes can trade, if no than no push n fail, only fbo or ext
        next confirm if we hit the 5m bull dev band on the fade off, if yes then we want to wait for the first 5m top top get cleared out if below pmh, if not hit then we are able to hit the first valid pop
        Valid pop level, 15m 9/20 bear dev band hit + 60% fib hit from high to pm low
        Over pmh is auto Valid
        Very open Centric Setup 10:30 Cutoff
        Max 2 5m bb
        
        [Untitled](OS%20D1%20Setup%20202d8836ce4380c9b9f1c58b7c2cc7f4/Untitled%2023ad8836ce438083aaf1e429f319a42f.csv)
        

Entry Processes

- Frontside Entries
    
    Max Loss 3R, max starter 2, max 5m bb 2, time cutoff 10:30… para blowoff strike allowed 
    
    | **High EV Spot** | **Starter** | **Pre Trig** | **Trig** |
    | --- | --- | --- | --- |
    | Opening FBO | 2m fbo | 2m BB | 5m BB |
    |  | 0.25R vs 10% stop | 0.25R vs 1c over highs | 1R vs 1c over highs |
    | Dev Band Pop | 1m fail candle | 2m bb | 5m BB |
    |  | 0.25R vs pmh | 0.25R vs 1c over highs | 1R vs 1c over highs |
    | Opening EXT |  | 2m bb | 5m BB |
    |  |  | 0.25R vs 10% stop | 1R vs 1c over highs |
- High Range Post Fail
    
    Valid EV Spots - Opening FBO, Opening 5m db push, Opening EXT, Morning FBO, Morning EXT
    
    Max Loss 3R, max starter 2, max 5m bb 2, time cutoff 10:30… para blowoff strike allowed 
    
    | **High EV Spot** | **Starter** | **Pre Trig** | **Trig** |
    | --- | --- | --- | --- |
    | Opening FBO | 2m fbo | 2m BB | 5m BB |
    |  | 0.25R vs 10% stop | 0.25R vs 1c over highs | 1R vs 1c over highs |
    | Dev Band Pop | 1m fail candle | 2m bb | 5m BB |
    |  | 0.25R vs pmh | 0.25R vs 1c over highs | 1R vs 1c over highs |
    | Opening EXT | 2m bb | 2m Trig | 5m BB |
    |  | 0.25R vs 10% stop | 0.25R vs 1c over highs | 1R vs 1c over highs |
    | Morning FBO | 2m fbo | 2m BB | 5m BB |
    |  | 0.25R vs 10% stop | 0.25R vs 1c over highs | 1R vs 1c over highs |
    | Morning EXT |  | 2m bb | 5m BB |
    |  |  | 0.25R vs 10% stop | 1R vs 1c over highs |
- Backside Pop
    
    Valid EV Spots - Opening FBO, Opening 15m db push, Opening EXT, Morning EXT (with blowout)
    
    Max Loss 3R, max starter 2, max 5m bb 2, time cutoff 10:30… para blowoff strike allowed 
    
    | **High EV Spot** | **Starter** | **Pre Trig** | **Trig** |
    | --- | --- | --- | --- |
    | Opening FBO | 2m fbo | 2m BB | 5m BB |
    |  | 0.25R vs 10% stop | 0.25R vs 1c over highs | 1R vs 1c over highs |
    | Dev Band Pop | 1m fail candle | 2m bb | 5m BB |
    |  | 0.25R vs pmh | 0.25R vs 1c over highs | 1R vs 1c over highs |
    | Opening EXT | 2m bb | 2m Trig | 5m BB |
    |  | 0.25R vs 10% stop | 0.25R vs 1c over highs | 1R vs 1c over highs |
    | Morning EXT |  | 2m bb | 5m BB |
    |  |  | 0.25R vs 10% stop | 1R vs 1c over highs |
- Deep Backside Pop & Reverted Backside
    
    first confirm that we had a liquid pm ext and fade off, if yes can trade, if no than no push n fail, only fbo or ext
    next confirm if we hit the 5m bull dev band on the fade off, if yes then we use backside reverted contingency, if not hit then we are able to hit the first valid pop
    
    Valid EV Spots - Opening FBO, Opening 15m db push + over 60% fib from pmh to fade off low, Opening EXT, Morning FBO
    
    Max Loss 3R, max starter 2, max 5m bb 2, time cutoff 10:30… para blowoff strike allowed 
    
    | **High EV Spot** | **Starter** | **Pre Trig** | **Trig** |
    | --- | --- | --- | --- |
    | Opening FBO | 2m fbo | 2m BB | 5m BB |
    |  | 0.25R vs 10% stop | 0.25R vs 1c over highs | 1R vs 1c over highs |
    | Dev Band Pop | 1m fail candle | 2m bb | 5m BB |
    |  | 0.25R vs pmh | 0.25R vs 1c over highs | 1R vs 1c over highs |
    | Opening EXT | 2m bb | 2m Trig | 5m BB |
    |  | 0.25R vs 10% stop | 0.25R vs 1c over highs | 1R vs 1c over highs |
    | Morning EXT |  | 2m bb | 5m BB |
    |  |  | 0.25R vs 10% stop | 1R vs 1c over highs |
    
    BACKSIDE REVERTED CONTINGENCY
    
    once backside has hit the 5m bull dev band, we want to see the first 5m top get cleared out, as this move has overly reverted so we want to see it use liq from the open to continue higher
    

## Pyramiding Strategy

Once Trigger activates, all setups follow the same process for pyramiding:

**Pyramid Signal**: 5m DB push

**Pyramid Trigger**: 2m BB

### Stop Checkpoints

- **5m VWAP or 2m 9/20 cross**: Small pyramid (≤15% from highs to vwap)
- Always prioritize swing highs
- Leave room as consolidating over VWAP is normal
- NOT IMPORTANT ADD FOR EV - DON'T FORCE
- **5m trig post 5m VWAP conf or 2m piv**: Medium pyramid (≤30% from highs to vwap)
- Always prioritize swing highs
- Leave room as we can still clear out
- 2m 9/20 cross + 2 checkpoints above - can build in consolidation (≤50% from highs to vwap)
- **Consolidation breakdown**: Aggressive pyramid vs last swing high near VWAP
- Should be done now 
- get aggressive
- **Non-breakdown adds**: As we roll or the 5m 9/20 flips - Look to pyramid on 5m DB pushes vs 2 swing high ago (on 2m at least, ideally 5m)
- For when you don't get the breakdown but are getting add opportunities in consolidation
- Or just in a downtrend leg

<aside>
**CUTOFF POINT**: Stop pyramiding once we hit the 5m J-line

</aside>

## Cover Strategy

The goal with covers is to capture the main 5m trend.

<aside>
Rule of thumb: 
Need to wait for true backside and 5m structure for trend trail. if not clear trend, use the 5m db, the db push with 5m trail is s tier trend indicator.
use guides like 5m, 10m, 15m 9/20 to start trail, vwap continuation, 2m bdb hit

IF 5m Dev band hasnt been tested with a 5m fail, then you cant trust lowering the high

</aside>

**Main cover Signal**: 5m BDB or the 5m 200EMA

Once we hit that, we begin looking for our 3 cover triggers:

| **Cover Trigger** | **Action** |
| --- | --- |
| 2m BB | Cover 1/3 |
| 5m BB | Cover 1/3 |
| 15m BB | Cover 1/3 |

**Special Cases:**

- Very steep move: Use the 1m BB and the 2m BB for 50% cover
- Very long tightening downtrend (or 5m BB/2m BB hasn't happened for a while): Look to cover more or get fully flat on the break
- The better the trend and deeper it goes, the less we want to wait for a curl

## Risk Management

- After 2 × 0.25R cuts: Wait for trigger to re-enter
- Only 2 5m trig allowed
- Maximum loss: 3R
- 10:30 cutoff for trig, in rare cases can allow acceptance when A+ setup + Blowout

## A+ Setup Criteria

- Gap stats
- Recent dilution
- Baggies
- Parabolics

- Recent amended dilution
- Strong cash need
- Positive historical diluter

- Give high range or over PMH entry
- Work early in the morning (first 15 min)

```python
import pandas as pd
import warnings
from pandas.errors import PerformanceWarning
import numpy as np
from datetime import time 
import pandas_market_calendars as mcal
import requests
from concurrent.futures import ThreadPoolExecutor, as_completed
from concurrent.futures import ThreadPoolExecutor, wait
us_calendar = mcal.get_calendar('NYSE')
# Suppress only PerformanceWarnings
warnings.filterwarnings("ignore", category=PerformanceWarning)

API_KEY = '4r6MZNWLy2ucmhVI7fY8MrvXfXTSmxpy'

FILENAME = "D:/TRADING/Backtesting/filtered/20_plus/temp/data_2019_current_temp.feather"
df = pd.read_feather(FILENAME)

start_date = pd.to_datetime('2024-01-01')
# start_date = pd.to_datetime('2023-01-01')
end_date = pd.to_datetime('2026-11-15')
df = df[
    (df['date'] >= start_date) & 
    (df['date'] <= end_date)
]

def get_last_bag_day_max_high(group):
    last_valid = group[group['bag_day_valid'] == 1].tail(1)
    return last_valid['bag_day_max_high'].values[0] if not last_valid.empty else None

def get_bag_day(df):
    # ]

    cols_to_check = ['bag_day']

    # Initialize the new column with zeros
    df['bag_day_valid1'] = 0

    # Group by ticker and apply rolling window
    for ticker, group in df.groupby('ticker'):
        # Create a temporary array to store results for this group
        trigger_array = (
            group[cols_to_check]  # Select the relevant columns
            .rolling(window=30, min_periods=1)  # Rolling window of 30 rows
            .max()  # Find max value within the window
            .max(axis=1)  # Check across all columns
        )

        
        # If any column has a 1 in the rolling window, mark the row
        df.loc[group.index, 'bag_day_valid1'] = (trigger_array > 0).astype(int)

    return df

df['prev_high'] = df.groupby('ticker')['high'].shift(1)

df['trig_day'] = ((df['pm_high'] / df['prev_close'] - 1>= .5) & 
                # (df['open'] >= ((df['pm_high'] - df['prev_close']) * 0.5 +  df['prev_close'])) & 
                (df['gap'] >= 0.5) & 
                (df['open'] / df['prev_high'] - 1>= .3) & 
                (df['pm_vol'] >= 5000000) & 
                (df['prev_close'] >= 0.75)).astype(int)

df['prev_close_1'] = df.groupby('ticker')['prev_close'].shift(1)
df['prev_volume'] = df.groupby('ticker')['volume'].shift(1)

df['d2'] = ((df['prev_close'] / df['prev_close_1'] - 1>= .3) & 
                (df['prev_volume'] >= 10000000)).astype(int)

def get_previous_trading_day(current_date, n=7):
    idx = trading_days.get_loc(current_date)
    return trading_days[max(0, idx - n)]

df['date'] = pd.to_datetime(df['date'])
start_date = df['date'].min() - pd.Timedelta(days=500)
end_date = df['date'].max() + pd.Timedelta(days=30)
schedule = us_calendar.schedule(start_date=start_date, end_date=end_date)
trading_days = schedule.index

df['date_minus_30'] = df['date'].apply(lambda x: get_previous_trading_day(x, n=31))
df['date_minus_2'] = df['date'].apply(lambda x: get_previous_trading_day(x, n=2))
df['date_minus_1'] = df['date'].apply(lambda x: get_previous_trading_day(x, n=1))
df['date_minus_100'] = df['date'].apply(lambda x: get_previous_trading_day(x, n=400))

df = df.sort_values(by=['date']).reset_index(drop=True)
start_date = pd.to_datetime('2025-01-01')
end_date = pd.to_datetime('2026-01-01')
df_trig_day = df[
    (df['date'] >= start_date) & 
    (df['date'] <= end_date) &
    (df['trig_day'] == 1)  #&
    # (df['ticker'] == "BETS") 
]

def fetch_daily_data(ticker, start_date, end_date, adjusted):
    # url = f'https://api.polygon.io/v2/aggs/ticker/{ticker}/range/1/day/{start_date}/{end_date}&sort=asc&limit=5000'
    url = f'https://api.polygon.io/v2/aggs/ticker/{ticker}/range/1/day/{start_date}/{end_date}?adjusted={adjusted}&sort=asc&limit=5000&apiKey={API_KEY}'
    # params = {
    #     'apiKey': API_KEY,
    #     'adjusted': adjusted
    # }
    # # Send request to Polygon API
    # response = requests.get(url, params=params)
    response = requests.get(url)
    
    if response.status_code == 200:
        data = response.json()
        if 'results' in data:
            return pd.DataFrame(data['results'])
    else:
        print(f"Error fetching data for {ticker}: {response.status_code}")
    return pd.DataFrame()

def adjust_daily(df):
    df['date'] = pd.to_datetime(df['t'], unit='ms')
    df['date'] = df['date'].dt.date          
    df['pdc'] = df['c'].shift(1)
    # df['ema50'] = df['c'].ewm(span=50, adjust=False).mean().fillna(0)
    # df['ema100'] = df['c'].ewm(span=100, adjust=False).mean().fillna(0)
    df['ema200'] = df['c'].ewm(span=200, adjust=False).mean().fillna(0)
    return df

def fetch_and_process_data(ticker, start_date, end_date, adjusted):
    data = fetch_daily_data(ticker, start_date, end_date, adjusted)
    # print(ticker, start_date, end_date, adjusted)
    # print(data)
    adjusted_data = adjust_daily(data)
    if adjusted == "false":
        adjusted_data.rename(columns={col: col + '_ua' if col not in ['date'] else col for col in adjusted_data.columns}, inplace=True)
    return adjusted_data

df_trig_day['ema_valid'] = 0

for i, row in df_trig_day.iterrows():

    try:
        #'''
        date = str(row['date'])[:10]
        date_minus_100 = str(row['date_minus_100'])[:10]
        date_minus_100 = "2018-01-01"
        date_minus_1 = str(row['date_minus_1'])[:10]
        ticker = row['ticker']
        print(date, ticker)

        adjusted = "true"
        daily_data = fetch_daily_data(ticker, date_minus_100, date_minus_1, adjusted)
        daily_data_a = adjust_daily(daily_data)

        #'''

        '''
        date = str(row['date'])[:10]
        date_minus_30 = str(row['date_minus_100'])[:10]
        date_minus_1 = str(row['date_minus_1'])[:10]
        date_minus_2 = str(row['date_minus_2'])[:10]
        ticker = row['ticker']
        print(date, ticker)
        with ThreadPoolExecutor(max_workers=4) as executor:
            futures = [
                executor.submit(fetch_and_process_data, ticker, date_minus_30, date_minus_2, "true"),
                executor.submit(fetch_and_process_data, ticker, date_minus_30, date_minus_2, "false"),
                executor.submit(fetch_and_process_data, ticker, date, date, "true"),
                executor.submit(fetch_and_process_data, ticker, date, date, "false")
            ]

            # Wait for all futures to complete
            wait(futures)

        # Extract results knowing the order
        daily_data_a = futures[0].result()
        daily_data_ua = futures[1].result()
        df_daily_trig_a = futures[2].result()
        df_daily_trig_ua = futures[3].result()

        # print(daily_data_a)
        # print(daily_data_ua)
        #'''

        c = daily_data_a['c'].iloc[-1]
        # ema50 = daily_data_a['ema50'].iloc[-1]
        # ema100 = daily_data_a['ema100'].iloc[-1]
        ema200 = daily_data_a['ema200'].iloc[-1]

        if c<=ema200*0.8 and len(daily_data_a)>=200:

            mc_url = f'https://api.polygon.io/v3/reference/tickers/{ticker}?date={date_minus_1}&apiKey=690tDzu9ibAcZZmQyqXSJNDImi_AtMp1'
            response = requests.get(mc_url)
            data = response.json()
            try:
                market_cap = data['results']['market_cap']
                market_cap = market_cap/1000000
                try:
                    os = data['results']['weighted_shares_outstanding']
                    url_c = f'https://api.polygon.io/v2/aggs/ticker/{ticker}/range/1/day/{date_minus_1}/{date_minus_1}?adjusted=false&sort=asc&limit=50&apiKey={API_KEY}'
                    response = requests.get(url_c)
                    data = response.json()
                    close_ua = data['results']['c']
                    market_cap = os * c
                    market_cap = market_cap/1000000

                except:
                    market_cap = "error"
            except:
                market_cap = "error"
            

            # print(date, ticker, ema50, c)
                                
            df_trig_day.loc[i, 'ema_valid'] = 1
            df_trig_day.loc[i, 'market_cap'] = market_cap

        else:
            df_trig_day.loc[i, 'ema_valid'] = 0

    except:
        print(date, ticker, "failed")
        df_trig_day.loc[i, 'ema_valid'] = 0

df_trig_day = df_trig_day[
    # (df_trig_day['ema_valid'] == 1) &
    (df_trig_day['d2'] == 0) 
]

print(df_trig_day)

df_trig_day.to_csv("D1 Gap.csv")
```

get d1s

[d1 db real](https://www.notion.so/202d8836ce4380ea9c19fb0057c6c5e1?pvs=21)